# Переработка агента создания документов

## Изменения

### 1. Новая специализация агента
Агент теперь генерирует **только протоколы обследования** на основе расшифровок встреч с заказчиком.

### 2. Строгая структура протокола
Создана Zod-схема (`lib/schemas/protocol-schema.ts`) для обеспечения следующей структуры:

1. **Дата встречи** - формат ДД.ММ.ГГГГ
2. **Повестка** - тема + пункты
3. **Участники** - таблицы со стороны Заказчика и Исполнителя (ФИО + должность)
4. **Термины и определения** - список терминов с определениями
5. **Сокращения и обозначения** - список сокращений
6. **Содержание встречи** - темы обсуждения, особенности миграции (таблицы)
7. **Вопросы и ответы** - пронумерованные списки
8. **Решения** - список решений с ответственными
9. **Открытые вопросы** - пронумерованный список
10. **Согласовано** - таблица с подписями

### 3. Анализ на противоречия
Перед генерацией протокола агент автоматически проверяет расшифровку на:
- Противоречия (взаимоисключающие утверждения)
- Недосказанности (неясные формулировки, недостающие детали)
- Критически важную недостающую информацию

Результаты анализа отображаются пользователю перед генерацией.

### 4. Генерация .docx файлов
- Создан генератор `lib/docx-generator.ts` с использованием библиотеки `docx`
- Протокол генерируется в формате .docx с правильным форматированием:
  - Таблицы с границами
  - Жирный шрифт для заголовков
  - Правильная нумерация разделов
  - Подписи в табличном формате

### 5. API endpoint для скачивания
- Создан endpoint `/api/download-docx/route.ts`
- Принимает base64-encoded содержимое .docx
- Возвращает файл с правильными заголовками для скачивания

### 6. UI обновления
**DocumentPanel.tsx:**
- Добавлена кнопка скачивания .docx (иконка FileText)
- Кнопка появляется только когда протокол сгенерирован
- Автоматическое скачивание с правильным именем файла

**app/page.tsx:**
- Добавлена обработка события `data-docx` из стрима
- Сохранение данных .docx в состоянии документа

**lib/document/types.ts:**
- Добавлено поле `docxData` в `DocumentState`

### 7. Удалено
- Функциональность редактирования документов (патчи)
- Возможность импровизации
- Универсальная генерация документов
- Все функции для работы с diagram/schema

## Установленные пакеты
```bash
npm install docx
```

## Использование

1. Пользователь отправляет расшифровку встречи с заказчиком
2. Агент анализирует расшифровку на противоречия и недосказанности
3. Агент генерирует структурированный протокол обследования
4. Протокол отображается в Markdown формате в правой панели
5. Автоматически генерируется .docx версия протокола
6. Пользователь может скачать .docx файл нажатием на кнопку с иконкой документа

## Структура файлов

```
lib/
  schemas/
    protocol-schema.ts          # Zod схемы для протокола и анализа
  docx-generator.ts              # Генератор .docx документов
  document/
    types.ts                     # Обновленные типы с docxData

app/
  api/
    chat/
      agents/
        document-agent.ts        # Переработанный агент
    download-docx/
      route.ts                   # API endpoint для скачивания

  page.tsx                       # Обработка data-docx событий

components/
  document/
    DocumentPanel.tsx            # Кнопка скачивания .docx
```

## Примечания

- Агент строго следует структуре из 10 разделов
- Не допускается импровизация - только факты из расшифровки
- При отсутствии данных явно указывается "Информация не предоставлена"
- .docx файл имеет имя формата: `Протокол_обследования_<номер>_<дата>.docx`
